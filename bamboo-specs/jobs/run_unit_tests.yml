key: RUT
docker:
  image: ${bamboo.artifactory_docker}/${bamboo.dind_docker_name}
  volumes:
    ${bamboo.working.directory}: ${bamboo.working.directory}
    ${bamboo.tmp.directory}: ${bamboo.tmp.directory}
  docker-run-arguments:
  - --pull
  - always
  - --privileged
  - --rm
tasks:
- checkout:
    force-clean-build: 'true'
    description: Checkout Default Repository
- inject-variables: 'bamboo-vars/.env-common'
- inject-variables: !include 'tasks/inject-vars-release.yml'
- inject-variables: !include 'tasks/inject-vars-master.yml'
- inject-variables: !include 'tasks/inject-vars-rc.yml'
- inject-variables: !include 'tasks/inject-vars-dev.yml'
- checkout:
    repository: acm-proto
    force-clean-build: 'true'
    path: acm-proto
- script:
    interpreter: /bin/sh
    file: bamboo-specs/scripts/run_unit_tests_compose.sh
    environment: docker_compose_file=${bamboo.inject.docker_compose_file} artifactory_pypi_url=${bamboo.inject.artifactory_pypi_url} sourceBranch=${bamboo.repository.pr.sourceBranch} targetBranch=${bamboo.repository.pr.targetBranch} shortPlanBranchName=${bamboo.shortPlanBranchName} shortPlanName=${bamboo.shortPlanName}
    description: Unit tests docker compose
    conditions: !include 'tasks/skip-build-condition.yml'
final-tasks:
- script:
    interpreter: /bin/sh
    file: bamboo-specs/scripts/final_docker_compose_unit_test.sh
    environment: docker_compose_file=${bamboo.inject.docker_compose_file} sourceBranch=${bamboo.repository.pr.sourceBranch} targetBranch=${bamboo.repository.pr.targetBranch} shortPlanBranchName=${bamboo.shortPlanBranchName} shortPlanName=${bamboo.shortPlanName} artifactory_docker_common_url=${bamboo.inject.artifactory_docker_common_url} YCSApub=${bamboo.secretYCSApub} YCSApriv=${bamboo.secretYCSApriv} username=${bamboo.secret_username} password=${bamboo.secret_password} yandex_url_docker=${bamboo.inject.yandex_url_docker} yandex_registry_id=${bamboo.inject.yandex_registry_id}
    description: cleanup docker compose
    conditions: !include 'tasks/skip-build-condition.yml'
requirements:
- system.docker.executable
- system.builder.command.Docker-compose
artifact-subscriptions: []
