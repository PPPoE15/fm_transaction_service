key: BSC
description: Run uvicorn and simple curl
tasks:
- checkout:
    force-clean-build: 'true'
    description: Checkout ${bamboo.shortPlanName} Repository
- inject-variables: 'bamboo-vars/.env-common'
- inject-variables: !include 'tasks/inject-vars-release.yml'
- inject-variables: !include 'tasks/inject-vars-master.yml'
- inject-variables: !include 'tasks/inject-vars-rc.yml'
- inject-variables: !include 'tasks/inject-vars-dev.yml'
- any-task:
    plugin-key: com.atlassian.bamboo.plugins.bamboo-docker-plugin:task.docker.cli
    configuration:
      commandOption: pull
      pullRepository: ${bamboo.artifactory_docker}/${bamboo.inject.python_pip_req_services}
      pullRegistryOption: custom
    description: Pull python_pre_cached docker image
    conditions: !include 'tasks/skip-build-condition.yml'
- any-task:
    plugin-key: com.atlassian.bamboo.plugins.bamboo-docker-plugin:task.docker.cli
    configuration: !include 'tasks/uvicorn_build.yml'
    description: Build uvicorn_up image with pip requirements installed
    conditions: !include 'tasks/skip-build-condition.yml'
- any-task:
    plugin-key: com.atlassian.bamboo.plugins.bamboo-docker-plugin:task.docker.cli
    configuration: !include 'tasks/uvicorn_up.yml'
    description: Run uvicorn with health check
    conditions: !include 'tasks/skip-build-condition.yml'
- any-task:
    plugin-key: com.atlassian.bamboo.plugins.bamboo-docker-plugin:task.docker.cli
    configuration: !include 'tasks/dramatiq_build.yml'
    description: Build dramatiq_up image with pip requirements installed
    conditions: !include 'tasks/skip-build-condition.yml'
- any-task:
    plugin-key: com.atlassian.bamboo.plugins.bamboo-docker-plugin:task.docker.cli
    configuration: !include 'tasks/dramatiq_up.yml'
    description: Run dramatiq for jobs with health check
    conditions: !include 'tasks/skip-build-condition.yml'
- any-task:
    plugin-key: com.atlassian.bamboo.plugins.bamboo-docker-plugin:task.docker.cli
    configuration: !include 'tasks/scheduler_build.yml'
    description: Build scheduler_up image with pip requirements installed
    conditions: !include 'tasks/skip-build-condition.yml'
- any-task:
    plugin-key: com.atlassian.bamboo.plugins.bamboo-docker-plugin:task.docker.cli
    configuration: !include 'tasks/scheduler_up.yml'
    description: Run scheduler without health check
    conditions: !include 'tasks/skip-build-condition.yml'
- script:
    interpreter: SHELL
    file: bamboo-specs/scripts/docker_push_registry.sh
    environment: artifactory_docker=${bamboo.artifactory_docker} python_pip_image=${bamboo.python_pip_image} YCSApub=${bamboo.secretYCSApub} YCSApriv=${bamboo.secretYCSApriv} python_pip_req_services=${bamboo.python_pip_req_services} username=${bamboo.secret_username} password=${bamboo.secret_password} yandex_url_docker=${bamboo.inject.yandex_url_docker} yandex_registry_id=${bamboo.inject.yandex_registry_id} python_image_to_run=${bamboo.inject.python_image_to_run} shortPlanName=${bamboo.shortPlanName} shortPlanBranchName=${bamboo.shortPlanBranchName} sourceBranch=${bamboo.repository.pr.sourceBranch} targetBranch=${bamboo.repository.pr.targetBranch}
    conditions: !include 'tasks/skip-build-condition.yml'
final-tasks:
- script:
    interpreter: SHELL
    file: bamboo-specs/scripts/final_script.sh
    environment: artifactory_docker=${bamboo.artifactory_docker} python_image_to_run=${bamboo.inject.python_image_to_run}
    description: cleanup
    conditions: !include 'tasks/skip-build-condition.yml'
requirements:
- system.docker.executable
artifact-subscriptions: []
