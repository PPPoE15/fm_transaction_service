  |

  #!/bin/bash

  set -eu

  ABS_PATH=/home/robot/sources
  MAIN_PROJECT_NAME="${bamboo.shortPlanName}"
  SERVICE_NAME=$(echo ${MAIN_PROJECT_NAME} | sed 's/acm-//')
  PROTO_SERVICE_NAME=acm-proto
  GIT_BRANCH="${bamboo.planRepository.branchName}"

  cd "$ABS_PATH"

  clone_func() {
      repo_name=$1
      if [ -d "$repo_name" ]
      then
          echo "Directory $repo_name exists."
          cd ./"$repo_name"
          git reset --hard
          git clean -xfdf
          git config pull.rebase true
          git fetch --all
          git checkout "$GIT_BRANCH"
          git pull
          cd ../
      else
          echo "Directory $repo_name does not exists."
          git clone -b "$GIT_BRANCH" ssh://git@git.astralinux.ru:7999/acm/"$repo".git
      fi
  }

  (
  flock -s 200

  for repo in "$MAIN_PROJECT_NAME";
  do
      clone_func "$repo"
  done

  cd acm-proto

  ./variable_substitution.sh

  docker compose logs | tail

  ) 200>/var/lock/bamboolockfile
